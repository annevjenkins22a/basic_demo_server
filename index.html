<!DOCTYPE html>
<html lang="en-gb">
<head>
    <title>Leasepath Quote</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0 user-scalable=no"/>
 
 
    <!-- Teneo Web Chat start -->
    <script src="teneo-web-chat.js"></script>
   <script>

 /*! For license information please see teneo-web-chat.js.LICENSE.txt */
const cookieName = 'myOldestSessID';
var prompt = '';
var fileType = '';
	
 window.onload = function () {
    watch_for_chat();
    if (
      window.TeneoWebChat &&
        typeof window.TeneoWebChat.initialize === 'function'
    ) {
      var element = document.getElementById('teneo-web-chat');
      var cookieCheck = getCookie(cookieName);
      console.log("cookieCheck1", cookieCheck);	    
      var teneoProps = {
        'teneoEngineUrl': 'https://violetpeacocks-e45133.bots.teneo.ai/leasepathquote_6phs505v768kcar619xnjqce33/',
        'channel':'leasepath',
	 'teneoEngineParams': {
        demo:'leasa', 
        channel:'leasa',
        botname:'Ava',
        currency:'GBP',
        prevSession:`${cookieCheck}`
        },      
        'title':'Talk to Ava from AVJ Finance',
        'autoRedirect':false,
        'showCloseButton':true,
        'first_use_asr_system_message':'',
        'showAsrButton':true,
        'showTtsButton':true,
        'msVoice':'en-GB-OliviaNeural',
        'msCognitiveSubscriptionKey':'2662d5847e284ea7b05a6c7134e364fd',
        'msCognitiveRegion':'eastus',
	'asrActive':true,
	'ttsActive':true,
	'locale':'en-GB',
	'voice':'en-GB-OliviaNeural'
      }
      window.TeneoWebChat.initialize(element,teneoProps);
    }
  }

function getCookie(name) {
  const value = `; ${document.cookie}`;
  //console.log("cookie values: ", value);	
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}		
	
 function onEngineResponse(payload) {
	// handle engine response event
    var response = payload.responseDetails;
   if(response.output.parameters.UploadImage && response.output.parameters.UploadImage=='Y') {
      TeneoWebChat.call('show_upload_panel');	
      prompt = response.output.parameters.prompt;
      fileType = response.output.parameters.fileType;
   }
   else {
	TeneoWebChat.call('hide_upload_panel');	 
   }
    if(response.output.parameters.msVoice && response.output.parameters.msVoice!="") {
    	TeneoWebChat.call('set_ms_voice', response.output.parameters.msVoice );
    	TeneoWebChat.call('set_locale',response.output.parameters.locale );
        console.log("voice", response.output.parameters.msVoice); 	    
        console.log("locale", response.output.parameters.locale);
    }
    var sessionId = response.sessionId;
    
    var cookieCheck = `${getCookie(cookieName)}`;
    console.log("cookieCheck", cookieCheck);
    if(cookieCheck===undefined || cookieCheck==='undefined' || cookieCheck=='undefined') {
    	document.cookie='myOldestSessID=' + sessionId + '; Max-Age=1707109200';
	console.log("cookieCreated", sessionId);    
    } 
    if(response.output.parameters.GDPRConsentRevoked && response.output.parameters.GDPRConsentRevoked=='Y') {
	document.cookie='myOldestSessID=GDPRConsentRevoked; Max-Age=1707109200';
	console.log("cookieUpdated to revoke: ", cookieCheck); 
    }
if(response.output.parameters.asyncComplete && response.output.parameters.asyncComplete=='false') {
var elements = document.getElementsByClassName('twc-user-input__send-icon-wrapper');
console.log('elements ' + elements);
var found = elements[0];
 console.log('found: ' + found);
if(found) setTimeout(function(){
	var elements = document.getElementsByClassName('twc-user-input__send-icon-wrapper');
	var found = elements[0];
 	console.log('found 2: ' + found);
	var value = document.getElementById("twc-user-input-field").value;
	console.log('value: ' + value);
	if(value==""){
		var teneoMsg = { "text": "continue",  "silent": true };
		TeneoWebChat.call('send_input', teneoMsg);
		//document.getElementById("twc-user-input-field").value="Continue";
		//found.click();
		console.log('submitting');
	}
	},1500);
}
	 
    /*else {
	if(!cookieCheck.includes(sessionId)) {
		document.cookie='myOldestSessID=' + sessionId + '-'+cookieCheck+'; Max-Age=1707109200';
	}
    }*/
}

TeneoWebChat.on('engine_response', onEngineResponse);
 function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


function getBase64(file, onLoadCallback) {
			    return new Promise(function(resolve, reject) {
			        var reader = new FileReader();
			        reader.onload = function() { resolve(reader.result); };
			        reader.onerror = reject;
			        reader.readAsDataURL(file);
			    });
			}

/**
 * A service-specific file uploader.
 * 
 * @const
 */
const fileUploader = {
  /**
   * Uploads file.
   * 
   * @param {object} item - the file-containing item as per
   * the definition of the item in 'upload_panel_submit'
   * @param {object} callback - a callback object
   * @param {function} callback.onSucceeded - called if the upload succeeded
   * @param {function} callback.onFailed - called if the upload failed
   * @param {function} callback.onUploadPercentageChanged - called when the update percentage
   * changed, with a number as its argument.
   */
  uploadFile(item, callback) {
    // item.file is uploaded here
	 var payload={'messages':[{'role':'system','content':[{'type':'text','text':'You are an AI assistant that helps read documents.'}]},{'role':'user','content':[{'type':'image_url','image_url':{'url':`${item.imageUrl}`}},{'type':'text','text':`${prompt}`}]}],'temperature':0.7,'top_p':0.95};
	 var dataUrl = item.imageUrl;
	  if(typeof item.imageUrl=="undefined") {
		        
			var promise = getBase64(item.file);
			promise.then(function(result) {
			    console.log(result);
			    dataUrl = toBase64(result);
				payload={'messages':[{'role':'system','content':[{'type':'text','text':'You are an AI assistant that helps read documents.'}]},{'role':'user','content':[{'type':'image_url','image_url':{'url':`${dataUrl}`}},{'type':'text','text':`${prompt}`}]}],'temperature':0.7,'top_p':0.95};
			});

		 	
	 }
	 while(typeof dataUrl=="undefined" || dataUrl=="") {
	 	//wait for promises to complete
		 sleep(200);
	 }
	  //  console.log("Content to Azure OAI: " + JSON.stringify(payload));
      var request = new Request('https://leasepathembedding.openai.azure.com/openai/deployments/gpt4omini/chat/completions?api-version=2024-02-15-preview&Content-Type=application/json&api-key=6ee42a5093c84304b98f2832320b1c61', 
         { method: 'POST', 
           body: JSON.stringify(payload), 
           headers: { 'Content-Type': 'application/json' } 
         });

        console.log("DEBUG: " + JSON.stringify(request.headers));
       console.log(request);
      
       // Now use it! 

   fetch(request).then(resp => { 
             // handle response 
	     console.log(resp);
	    var respData = resp.json();
	   console.log(respData);
	   return respData;
   }) 
    .then(function (json) {
        //console.log(json.choices[0].message.content);
	 var teneoMsg = { "text": "uploading",  "silent": true , "parameters" : {"payload": JSON.stringify(json.choices[0].message.content).substring(7), "fileType": fileType }};
	 //var teneoMsg = { "text": "uploading",  "parameters" : {"payload": JSON.stringify(json.choices[0].message.content).substring(7), "fileType": fileType }};
	console.log(JSON.stringify(teneoMsg));
    	TeneoWebChat.call('send_input', teneoMsg);
    })
	   .catch(err => { 
             // handle errors 
        });
  
  
    //var teneoMsg = { "text": "uploading",  "silent": true , "parameters" : {"payload": item.imageUrl} };
    TeneoWebChat.call('add_message', "Processing file.");
    console.log('submitting file upload');	  
  },

  /**
   * Deletes the uploaded file.
   * 
   * @param {string} itemId - the identifier of the file to delete
   * @param {object} callback - a callback object
   * @param {function} callback.onSucceeded - called if the deletion succeeded
   * @param {function} callback.onFailed - called if the deletion failed
   */
  deleteFile(itemId, callback) {
  },

  /**
   * Interrupts the file upload.
   * 
   * @param {string} itemId - the identifier of the file to delete
   * @param {object} callback - a callback object
   * @param {function} callback.onSucceeded - called if the deletion succeeded
   * @param {function} callback.onFailed - called if the deletion failed
   */
  interrupt(itemId) {
  },

  /**
   * Interrupts all the ongoing file uploads at once.
   */
  interruptAll() {
  }
};


function doFileUpload(item) {

  // Adding the upload message with for the given file:
  TeneoWebChat.call('add_message', {
    type: 'upload',
    author: 'user',
    data: {
      itemId: item.id,
      fileName: item.file.name,
      fileSymbol: item.file.name.substring(item.file.name.lastIndexOf('.') + 1),
      initialUploadState: {
        status: 'IN_PROGRESS',
        controlAllowed: true
      }
    }
  });

  // Starting the file upload and setting dynamically the upload state for each file:
  fileUploader.uploadFile(item, {
    onSucceeded: () => {
      TeneoWebChat.call('set_upload_state', {
          itemId: item.id,
          uploadState: {
            status: 'SUCCEEDED'
          }
      });
    },
    onFailed: () => {
      TeneoWebChat.call('set_upload_state', {
          itemId: item.id,
          uploadState: {
            status: 'FAILED',
            uploadPercentage: 0
          }
      });
    },
    onInterrupted: () => {
      TeneoWebChat.call('set_upload_state', {
          itemId: item.id,
          uploadState: {
            status: 'INTERRUPTED',
            uploadPercentage: 0
          }
      });
    },
    onUploadPercentageChanged: uploadPercentage => {
      TeneoWebChat.call('set_upload_state', {
          itemId: item.id,
          uploadState: {
            uploadPercentage: uploadPercentage
          }
      });
    }
  });
}


TeneoWebChat.on('upload_panel_submit', payload => {
  payload.items.forEach(item => doFileUpload(item));
});


TeneoWebChat.on('upload_panel_cancel', payload => {
  TeneoWebChat.call('add_message', {
      type: 'text',
      author: 'bot',
      data: { text: 'You have canceled on ' + payload.itemsCount + ' files' }
  });    
});


TeneoWebChat.on('upload_file_delete_clicked', payload => {
  fileUploader.deleteFile(payload.itemId, {
    onSucceeded: () => {
      TeneoWebChat.call('set_upload_state', {
        itemId: itemId,
        uploadState: {
          status: 'DELETED',
          uploadPercentage: 0
        }
      });
    },
    onFailed: () => {
      console.warn('Deletion failed for itemId', payload.itemId);
    }
  });
});


TeneoWebChat.on('upload_file_stop_clicked', payload => {
  fileUploader.interrupt(payload.itemId);
});


TeneoWebChat.on('reset', () => {
  fileUploader.interruptAll();
});

</script>  
<script>
 

const resize_spec = '* 1.5';
 
function find_node( path, context )
{
     var found = document.evaluate( path, context, null,
                                    XPathResult.ANY_UNORDERED_NODE_TYPE, null );
     return ( found && found.singleNodeValue ) ? found.singleNodeValue : null;
}

function watch_for_chat ()
{
    const sentinel2 = function(mutants, observer)
    {
        for( const mutant of mutants )
        {
            var found = false;
            if (mutant.type != 'childList')
                 continue;

            var added = mutant.addedNodes;
            for (let i = 0; i < added.length; i++)
            {
                if( added[i].id == 'twc-chat-window' )
                    found = added[i];
                else
                    found = find_node( "//*[@id='twc-chat-window']", added[i] );

                if( found )
                {
                    var width;
                    var style = window.getComputedStyle( found );
                    //width = 'calc( ' + style.width + ' ' + resize_spec + ' )';
                    width='40%';
                    found.style['min-height'] = '95%';
                    found.style.width = width;
                    break;
                }
            }
        }    
    };

    const sentinel1 = function(mutants, observer)
    {
        for( const mutant of mutants )
        {
            var found = false;
            if (mutant.type != 'childList')
                 continue;

            var added = mutant.addedNodes;
            for (let i = 0; i < added.length; i++)
            {
                if( added[i].id == 'twc-launchbutton' )
                    found = added[i];
                else
                    found = find_node( "//*[@id='twc-launchbutton']", added[i] );

                if( found )
                {
                    observer.disconnect();
                    found.click();
                    break;
                }
           }
        }
    };

    const target   = document.getElementsByTagName('body')[0];
    const config   = { attributes: false, childList: true, subtree: true };; 
 
    if( target )
    {
         const open = new MutationObserver( sentinel1 );
         const wide = new MutationObserver( sentinel2 )
         if( open )
             open.observe( target, config );
         if( wide )
             wide.observe( target, config );
    }
}
  </script>
  <style>
 .teneo-web-chat {
 --primary-font: "Open Sans", Arial, sans-serif !important;
  font-family: "Open Sans", Arial, sans-serif !important;
  font-size: 18px !important;
  font: Open Sans Regular,Arial,sans-serif  !important;
  --quickreply-fg-color: #89031b !important;
  --quickreply-border-color: #89031b !important;	 
  --quick-reply-bg-color: #89031b !important;
  --primary-color: #89031b !important;
  --header-fg-color: #ffffff !important; 
  --light-bg-color: #89031b !important;
  --launch-button-bg-color: #89031b !important;
  --header-bg-color: #89031b !important;
  --bot-message-fg-color: #000000 !important;
  --card-bg-color: #89031b !important;
  --form-subtitle-text-color: #afc7e0 !important;
  --dark-fg-color: #89031b !important;
  --success-color: #a3818a !important;
  --danger-color: #ee5743 !important;
  --secondary-color: #333333 !important;
  --light-fg-color: #afc7e0 !important;
  --user-message-fg-color: #ffffff !important;
  --user-message-bg-color: #89031b !important;
  --bot-message-bg-color: #afc7e0 !important;  
  --callout-fg-color: #000000 !important;  
  --sendicon-fg-color: #000000 !important;
  --ttsicon-fg-color: #000000 !important;
  --asricon-fg-color: #000000 !important;
  --form-input-background-color: #89031b !important;
  --quickreply-expired-color: #89031b !important;
  --card-bg-color: #ffffff !important;
  --text-link-color: #000000 !important;
  --user-typing-indicator-fg-color: #000000 !important;
  --user-typing-indicator-bg-color: #afc7e0 !important;
} 
.twc-user-input.twc-active {
  --user-message-bg-color: #afc7e0 !important;
  --user-message-fg-color: #89031b !important;
  --form-input-background-color: #afc7e0  !important;
}	  
.twc-chat-window {
	font-family: Verdana, sans-serif;
}
	  
.twc-text-message {
  font-size: 18px !important;	
  font-family: Arial, sans-serif;
}
	 
.twc-text-message__text {
  font-size: 18px !important;	
  font-family: Arial, sans-serif;
}
	  
// button drop shadow
.twc-launch-button:hover {
  box-shadow: 0 0px 27px 1.5px rgba(0, 0, 0, 0.2);
}

// increase size of the icon slightly
.twc-launch-button:hover .twc-launch-button__open-icon {
  transform: scale(1.5);
}   
</style>
 </head>
    <body>
<!-- Teneo Web Chat end -->
    
<img class="image1" crossOrigin="anonymous" src="https://avj-images.s3.eu-west-2.amazonaws.com/avjfinance.jpg" style="width:100%" /> 

<!-- Teneo Web Chat start -->
<div id="teneo-web-chat"></div>
<!--div id="leopardChatWindow"></div>
<script src="https://afs-customer-services.herokuapp.com/embed-leopard.js"></script-->
    </body>
</html>
